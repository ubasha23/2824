<?xml version="1.0" encoding="UTF-8"?>
<xml-fragment xmlns:ser="http://www.bea.com/wli/sb/services" xmlns:tran="http://www.bea.com/wli/sb/transports" xmlns:env="http://www.bea.com/wli/config/env" xmlns:http="http://www.bea.com/wli/sb/transports/http" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:con="http://www.bea.com/wli/sb/pipeline/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config">
  <ser:coreEntry isProxy="true" isEnabled="true">
    <ser:binding type="Mixed" xsi:type="con:MixedBindingType" xmlns:con="http://www.bea.com/wli/sb/services/bindings/config">
      <con:request type="Text"/>
      <con:response type="Text"/>
    </ser:binding>
    <ser:monitoring isEnabled="false">
      <ser:aggregationInterval>10</ser:aggregationInterval>
      <ser:pipelineMonitoringLevel>Pipeline</ser:pipelineMonitoringLevel>
    </ser:monitoring>
    <ser:reporting>true</ser:reporting>
    <ser:logging isEnabled="true">
      <ser:logLevel>debug</ser:logLevel>
    </ser:logging>
    <ser:sla-alerting isEnabled="true">
      <ser:alertLevel>normal</ser:alertLevel>
    </ser:sla-alerting>
    <ser:pipeline-alerting isEnabled="true">
      <ser:alertLevel>normal</ser:alertLevel>
    </ser:pipeline-alerting>
  </ser:coreEntry>
  <ser:endpointConfig>
    <tran:provider-id>http</tran:provider-id>
    <tran:inbound>true</tran:inbound>
    <tran:URI>
      <env:value>/corporateUsers</env:value>
    </tran:URI>
    <tran:inbound-properties/>
    <tran:all-headers>false</tran:all-headers>
    <tran:provider-specific>
      <http:inbound-properties/>
      <http:request-encoding>utf-8</http:request-encoding>
      <http:response-encoding>utf-8</http:response-encoding>
    </tran:provider-specific>
  </ser:endpointConfig>
  <ser:router errorHandler="_onErrorHandler-5103501488779744090--16f5ae4c.140538b7dc4.-7f4b">
    <con:pipeline type="request" name="Get Corporate User_request">
      <con:stage name="Setup">
        <con:context xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/typesystem/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con1:userNsDecl namespace="http://www.bea.com/wli/sb/services/security/config" prefix="con"/>
        </con:context>
        <con:actions xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/typesystem/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con5:assign varName="startTimestamp" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con4="http://www.bea.com/wli/sb/pipeline/config" xmlns:aler="http://www.bea.com/wli/monitoring/alert" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7fbd</con1:id>
            <con5:expr>
              <con:xqueryText xmlns:con="http://www.bea.com/wli/sb/stages/config">current-dateTime()</con:xqueryText>
            </con5:expr>
          </con5:assign>
          <con1:ifThenElse xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7fc1</con5:id>
            <con1:case>
              <con1:condition>
                <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">fn:not(fn:exists($inbound/ctx:transport/ctx:request/http:query-string))</con5:xqueryText>
              </con1:condition>
              <con1:actions>
                <con1:Error>
                  <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7fc0</con5:id>
                  <con1:errCode>400</con1:errCode>
                  <con1:message>Bad Request</con1:message>
                </con1:Error>
              </con1:actions>
            </con1:case>
          </con1:ifThenElse>
          <con1:assign varName="params" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7fbf</con5:id>
            <con1:expr>
              <con5:xqueryTransform xmlns:con5="http://www.bea.com/wli/sb/stages/config">
                <con5:resource ref="Common/transformations/XQ_Parse_QueryString"/>
                <con5:param name="qs">
                  <con5:path>data($inbound/ctx:transport/ctx:request/http:query-string)</con5:path>
                </con5:param>
              </con5:xqueryTransform>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="callback" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7fbb</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="callback"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="token" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7fb8</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="token"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="clientId" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7fac</con5:id>
            <con1:expr>
              <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">$params/param[@name="clientId"]/@value</con2:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="userId" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7f6d</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="userId"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con5:assign varName="impersonationId" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-5012024788670956757--641e3a29.140cdcef70f.-7dbf</con1:id>
            <con5:expr>
              <con1:xqueryText>$params/param[@name="impersonationId"]/@value</con1:xqueryText>
            </con5:expr>
          </con5:assign>
          <con1:assign varName="method" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7f50</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="method"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con2:ifThenElse xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-5012024788670956757--641e3a29.140cdcef70f.-7afd</con1:id>
            <con2:case>
              <con2:condition>
                <con1:xqueryText>fn:empty($impersonationId)</con1:xqueryText>
              </con2:condition>
              <con2:actions>
                <con2:assign varName="personId">
                  <con1:id>_ActionId-5012024788670956757--641e3a29.140cdcef70f.-7afc</con1:id>
                  <con2:expr>
                    <con1:xqueryText>$userId</con1:xqueryText>
                  </con2:expr>
                </con2:assign>
              </con2:actions>
            </con2:case>
            <con2:default>
              <con2:assign varName="personId">
                <con1:id>_ActionId-5012024788670956757--641e3a29.140cdcef70f.-7afb</con1:id>
                <con2:expr>
                  <con1:xqueryText>$impersonationId</con1:xqueryText>
                </con2:expr>
              </con2:assign>
            </con2:default>
          </con2:ifThenElse>
        </con:actions>
      </con:stage>
      <con:stage name="Validate token">
        <con:context xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config"/>
        <con:actions xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config">
          <con4:javaCallout varName="session" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
            <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7fb1</con2:id>
            <con4:archive ref="partnerServices/PartnerMWSupport"/>
            <con4:className>fi.finnair.session.SessionRegistry</con4:className>
            <con4:method>public static java.lang.String getSession(java.lang.String)</con4:method>
            <con4:expr>
              <con2:xqueryText>$token</con2:xqueryText>
            </con4:expr>
          </con4:javaCallout>
          <con4:ifThenElse xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
            <con2:comment>Check for dummy token</con2:comment>
            <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7fb0</con2:id>
            <con4:case>
              <con4:condition>
                <con2:xqueryText>fn:not(fn:contains($session, concat('&lt;userid>', $userId, '&lt;/userid>')))</con2:xqueryText>
              </con4:condition>
              <con4:actions>
                <con4:Error>
                  <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7faf</con2:id>
                  <con4:errCode>400</con4:errCode>
                  <con4:message>Bad Request</con4:message>
                </con4:Error>
              </con4:actions>
            </con4:case>
          </con4:ifThenElse>
        </con:actions>
      </con:stage>
      <con:stage name="Get Profiles" errorHandler="_onErrorHandler-5103501488779744090--16f5ae4c.140538b7dc4.-7d27">
        <con:context>
          <con1:userNsDecl namespace="http://com.finnair" prefix="com"/>
          <con1:varNsDecl namespace="http://www.example.org/GetCorporateUserProfile/" prefix="get"/>
        </con:context>
        <con:actions>
          <con2:wsCallout>
            <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7d79</con1:id>
            <con2:service xsi:type="ref:ProxyRef" ref="CorporateUserProfile/proxies/GetCorporateUserProfileSalesforce" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con2:operation>GetCorporateUserProfile</con2:operation>
            <con2:request>
              <con2:body>$getProfilesRQ</con2:body>
            </con2:request>
            <con2:response>
              <con2:body>getProfilesRS</con2:body>
            </con2:response>
            <con2:requestTransform>
              <con2:ifThenElse>
                <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7d49</con1:id>
                <con2:case>
                  <con2:condition>
                    <con1:xqueryText>$method eq "all"</con1:xqueryText>
                  </con2:condition>
                  <con2:actions>
                    <con2:assign varName="getProfilesRQ">
                      <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7d38</con1:id>
                      <con2:expr>
                        <con1:xqueryText><![CDATA[<com:AMA_ProfileReadRQ Version="12.2">
         <com:ExternalID Type="1" ID="{$clientId}" ID_Context="AY_Company_Key"/>
         <com:ReadRequests>
            <com:ProfileReadRequest ProfileType="1"/>
         </com:ReadRequests>
      </com:AMA_ProfileReadRQ>]]></con1:xqueryText>
                      </con2:expr>
                    </con2:assign>
                  </con2:actions>
                </con2:case>
                <con2:default>
                  <con2:assign varName="getProfilesRQ">
                    <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7d28</con1:id>
                    <con2:expr>
                      <con1:xqueryText><![CDATA[<com:AMA_ProfileReadRQ Version="12.2">
         <com:UniqueID Type="1" ID="{$personId}" ID_Context="Username"/>
         <com:ReadRequests>
            <com:ProfileReadRequest ProfileType="1"/>
         </com:ReadRequests>
      </com:AMA_ProfileReadRQ>]]></con1:xqueryText>
                    </con2:expr>
                  </con2:assign>
                </con2:default>
              </con2:ifThenElse>
            </con2:requestTransform>
            <con2:responseTransform/>
          </con2:wsCallout>
        </con:actions>
      </con:stage>
      <con:stage name="validate impersonation">
        <con:context>
          <con1:userNsDecl namespace="http://com.finnair" prefix="com"/>
        </con:context>
        <con:actions>
          <con2:ifThenElse>
            <con1:id>_ActionId-5012024788670956757--641e3a29.140cdcef70f.-7e4a</con1:id>
            <con2:case>
              <con2:condition>
                <con1:xqueryText>fn:exists($impersonationId) and $impersonationId != $userId</con1:xqueryText>
              </con2:condition>
              <con2:actions>
                <con2:wsCallout>
                  <con1:id>_ActionId-5012024788670956757--641e3a29.140cdcef70f.-7cbe</con1:id>
                  <con2:service xsi:type="ref:ProxyRef" ref="CorporateUserProfile/proxies/GetCorporateUserProfileSalesforce" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                  <con2:operation>GetCorporateUserProfile</con2:operation>
                  <con2:request>
                    <con2:body>$getAdminUserProfileRQ</con2:body>
                  </con2:request>
                  <con2:response>
                    <con2:body>getAdminUserProfileRS</con2:body>
                  </con2:response>
                  <con2:requestTransform>
                    <con2:assign varName="getAdminUserProfileRQ">
                      <con1:id>_ActionId-5012024788670956757--641e3a29.140cdcef70f.-7c83</con1:id>
                      <con2:expr>
                        <con1:xqueryText><![CDATA[<com:AMA_ProfileReadRQ Version="12.2">
         <com:UniqueID Type="21" ID="{$userId}" ID_Context="Username"/>
         <com:ReadRequests>
            <com:ProfileReadRequest ProfileType="1"/>
         </com:ReadRequests>
      </com:AMA_ProfileReadRQ>]]></con1:xqueryText>
                      </con2:expr>
                    </con2:assign>
                  </con2:requestTransform>
                  <con2:responseTransform/>
                </con2:wsCallout>
                <con2:ifThenElse>
                  <con1:id>_ActionId-5012024788670956757--641e3a29.140cdcef70f.-7b71</con1:id>
                  <con2:case>
                    <con2:condition>
                      <con1:xqueryText>$method eq "all"</con1:xqueryText>
                    </con2:condition>
                    <con2:actions>
                      <con2:ifThenElse>
                        <con1:id>_ActionId-5012024788670956757--641e3a29.140cdcef70f.-7b37</con1:id>
                        <con2:case>
                          <con2:condition>
                            <con1:xqueryText>$getAdminUserProfileRS/com:ExternalID[@ID_Context='AY_Company_Key']/@ID != $clientId</con1:xqueryText>
                          </con2:condition>
                          <con2:actions>
                            <con2:Error>
                              <con1:id>_ActionId-5012024788670956757--641e3a29.140cdcef70f.-7a8b</con1:id>
                              <con2:errCode>400</con2:errCode>
                              <con2:message>Bad request</con2:message>
                            </con2:Error>
                          </con2:actions>
                        </con2:case>
                      </con2:ifThenElse>
                    </con2:actions>
                  </con2:case>
                  <con2:default>
                    <con2:ifThenElse>
                      <con1:id>_ActionId-5012024788670956757--641e3a29.140cdcef70f.-7b6f</con1:id>
                      <con2:case>
                        <con2:condition>
                          <con1:xqueryConditionExpr>
                            <con1:boolExpr operator="or">
                              <con1:compExpr operator="!=">
                                <con1:leftPath>$getAdminUserProfileRS/com:ExternalID[@ID_Context='AY_Company_Key']/@ID</con1:leftPath>
                                <con1:rightPath>$getProfilesRS/com:ExternalID[@ID_Context='AY_Company_Key']/@ID</con1:rightPath>
                              </con1:compExpr>
                              <con1:compExpr operator="!=">
                                <con1:leftPath>$getAdminUserProfileRS/com:Profile/com:Agreements/com:OwnerRights/@RoleId</con1:leftPath>
                                <con1:rightPath>"A"</con1:rightPath>
                              </con1:compExpr>
                            </con1:boolExpr>
                          </con1:xqueryConditionExpr>
                        </con2:condition>
                        <con2:actions>
                          <con2:Error>
                            <con1:id>_ActionId-5012024788670956757--641e3a29.140cdcef70f.-7ac3</con1:id>
                            <con2:errCode>400</con2:errCode>
                            <con2:message>Bad request</con2:message>
                          </con2:Error>
                        </con2:actions>
                      </con2:case>
                    </con2:ifThenElse>
                  </con2:default>
                </con2:ifThenElse>
              </con2:actions>
            </con2:case>
          </con2:ifThenElse>
        </con:actions>
      </con:stage>
    </con:pipeline>
    <con:pipeline type="response" name="Get Corporate User_response">
      <con:stage name="ConvertToJSON">
        <con:context xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con1:userNsDecl namespace="http://com.finnair" prefix="com"/>
        </con:context>
        <con:actions xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con5:assign varName="profilesJSON" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-2189079135354840814--601c1517.140a6003694.-7fb7</con1:id>
            <con5:expr>
              <con1:xqueryTransform>
                <con1:resource ref="CorporateUserProfile/transformations/Profiles2JSON"/>
                <con1:param name="profiles">
                  <con1:path>$getProfilesRS</con1:path>
                </con1:param>
              </con1:xqueryTransform>
            </con5:expr>
          </con5:assign>
          <con5:assign varName="profilesJSON" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-5370770740765045215--6de0d096.140c8d7cabc.-7f6e</con1:id>
            <con5:expr>
              <con1:xqueryText>fn:replace($profilesJSON,"\}\{","},{")</con1:xqueryText>
            </con5:expr>
          </con5:assign>
          <con5:replace varName="body" contents-only="true" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7fa7</con1:id>
            <con5:location>
              <con1:xpathText>.</con1:xpathText>
            </con5:location>
            <con5:expr>
              <con1:xqueryText>fn:concat($callback, "(", $profilesJSON, ")")</con1:xqueryText>
            </con5:expr>
          </con5:replace>
          <con5:transport-headers xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7fa6</con1:id>
            <con5:header-set>inbound-response</con5:header-set>
            <con5:header name="Content-Type" value="expression">
              <con1:xqueryText>'application/json'</con1:xqueryText>
            </con5:header>
          </con5:transport-headers>
        </con:actions>
      </con:stage>
      <con:stage name="Monitoring">
        <con:comment/>
        <con5:context xmlns:con="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/pipeline/config" xmlns:con5="http://www.bea.com/wli/sb/pipeline/config" xmlns:con4="http://www.bea.com/wli/sb/stages/alert/config" xmlns:aler="http://www.bea.com/wli/monitoring/alert" xmlns:con1="http://www.bea.com/wli/sb/typesystem/config">
          <con6:varNsDecl prefix="com" namespace="http://com.finnair" xmlns:con6="http://www.bea.com/wli/sb/stages/config"/>
          <con6:varNsDecl prefix="prof" namespace="http://com.finnair/profileProcessing/" xmlns:con6="http://www.bea.com/wli/sb/stages/config"/>
        </con5:context>
        <con5:actions xmlns:con="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/pipeline/config" xmlns:con5="http://www.bea.com/wli/sb/pipeline/config" xmlns:con4="http://www.bea.com/wli/sb/stages/alert/config" xmlns:aler="http://www.bea.com/wli/monitoring/alert" xmlns:con1="http://www.bea.com/wli/sb/typesystem/config">
          <con4:route xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config">
            <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-3004770720133324222-4eab63bf.1402e36470a.-7fa2</con6:id>
            <con4:service ref="GoogleAnalytics/businessservice/Monitoring" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con4:operation>monitor</con4:operation>
            <con4:outboundTransform>
              <con2:replace varName="body" contents-only="true">
                <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-3004770720133324222-4eab63bf.1402e36470a.-7fa1</con6:id>
                <con2:location>
                  <con6:xpathText xmlns:con6="http://www.bea.com/wli/sb/stages/config">.</con6:xpathText>
                </con2:location>
                <con2:expr>
                  <con6:xqueryTransform xmlns:con6="http://www.bea.com/wli/sb/stages/config">
                    <con6:resource ref="GoogleAnalytics/transformations/XQ_Req_Monitoring"/>
                    <con6:param name="startTimestamp">
                      <con6:path>$startTimestamp</con6:path>
                    </con6:param>
                    <con6:param name="inbound">
                      <con6:path>$inbound</con6:path>
                    </con6:param>
                  </con6:xqueryTransform>
                </con2:expr>
              </con2:replace>
            </con4:outboundTransform>
          </con4:route>
          <con1:reply xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con="http://www.bea.com/wli/sb/pipeline/config" xmlns:con2="http://www.bea.com/wli/sb/typesystem/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config">
            <con1:id>_ActionId-3004770720133324222-4eab63bf.1402e36470a.-7fa0</con1:id>
          </con1:reply>
        </con5:actions>
      </con:stage>
    </con:pipeline>
    <con:pipeline type="error" name="_onErrorHandler-5103501488779744090--16f5ae4c.140538b7dc4.-7f4b">
      <con:stage name="Error handling">
        <con:context xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config"/>
        <con:actions xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config">
          <con4:ifThenElse xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
            <con2:id>_ActionId-3587372809334780688--2e9df170.1405cdffe1a.-7fed</con2:id>
            <con4:case>
              <con4:condition>
                <con2:xqueryText>empty($ErrorCode)</con2:xqueryText>
              </con4:condition>
              <con4:actions>
                <con4:assign varName="ErrorCode">
                  <con2:id>_ActionId-3587372809334780688--2e9df170.1405cdffe1a.-7feb</con2:id>
                  <con4:expr>
                    <con2:xqueryText>data($fault/ctx:errorCode)</con2:xqueryText>
                  </con4:expr>
                </con4:assign>
              </con4:actions>
            </con4:case>
          </con4:ifThenElse>
          <con4:replace contents-only="true" varName="body" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
            <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7f45</con2:id>
            <con4:location>
              <con2:xpathText>.</con2:xpathText>
            </con4:location>
            <con4:expr>
              <con2:xqueryText>fn:concat(
$callback,
"({",
"'error':'", $ErrorCode,"'",
"})"
)</con2:xqueryText>
            </con4:expr>
          </con4:replace>
          <con3:log>
            <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7f44</con2:id>
            <con3:logLevel>error</con3:logLevel>
            <con3:expr>
              <con2:xqueryText>$fault</con2:xqueryText>
            </con3:expr>
          </con3:log>
          <con2:reply isError="false">
            <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7f43</con2:id>
          </con2:reply>
        </con:actions>
      </con:stage>
    </con:pipeline>
    <con:pipeline type="request" name="Update Corporate User_request">
      <con:stage name="Setup">
        <con:context xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/typesystem/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con1:userNsDecl namespace="http://www.bea.com/wli/sb/services/security/config" prefix="con"/>
        </con:context>
        <con:actions xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/typesystem/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con5:assign varName="startTimestamp" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con4="http://www.bea.com/wli/sb/pipeline/config" xmlns:aler="http://www.bea.com/wli/monitoring/alert" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e7e</con1:id>
            <con5:expr>
              <con:xqueryText xmlns:con="http://www.bea.com/wli/sb/stages/config">current-dateTime()</con:xqueryText>
            </con5:expr>
          </con5:assign>
          <con1:ifThenElse xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e7d</con5:id>
            <con1:case>
              <con1:condition>
                <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">fn:not(fn:exists($inbound/ctx:transport/ctx:request/http:query-string))</con5:xqueryText>
              </con1:condition>
              <con1:actions>
                <con1:Error>
                  <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e7c</con5:id>
                  <con1:errCode>400</con1:errCode>
                  <con1:message>Bad Request</con1:message>
                </con1:Error>
              </con1:actions>
            </con1:case>
          </con1:ifThenElse>
          <con1:assign varName="params" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e7b</con5:id>
            <con1:expr>
              <con5:xqueryTransform xmlns:con5="http://www.bea.com/wli/sb/stages/config">
                <con5:resource ref="Common/transformations/XQ_Parse_QueryString"/>
                <con5:param name="qs">
                  <con5:path>data($inbound/ctx:transport/ctx:request/http:query-string)</con5:path>
                </con5:param>
              </con5:xqueryTransform>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="callback" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e7a</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="callback"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="token" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e79</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="token"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="clientId" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e78</con5:id>
            <con1:expr>
              <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">$params/param[@name="clientId"]/@value</con2:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="userId" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e77</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="userId"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="method" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e76</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="method"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con5:assign varName="upUserId" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-7415848483617704918-2167905b.14102d09993.-7bbc</con1:id>
            <con5:expr>
              <con1:xqueryText>$params/param[@name="upUserId"]/@value</con1:xqueryText>
            </con5:expr>
          </con5:assign>
          <con5:assign varName="password" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-724e</con1:id>
            <con5:expr>
              <con1:xqueryText>fn:normalize-space($params/param[@name="password"]/@value)</con1:xqueryText>
            </con5:expr>
          </con5:assign>
        </con:actions>
      </con:stage>
      <con:stage name="Validate token">
        <con:context xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config"/>
        <con:actions xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config">
          <con4:javaCallout varName="session" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
            <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e75</con2:id>
            <con4:archive ref="partnerServices/PartnerMWSupport"/>
            <con4:className>fi.finnair.session.SessionRegistry</con4:className>
            <con4:method>public static java.lang.String getSession(java.lang.String)</con4:method>
            <con4:expr>
              <con2:xqueryText>$token</con2:xqueryText>
            </con4:expr>
          </con4:javaCallout>
          <con4:ifThenElse xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
            <con2:comment>Check for dummy token</con2:comment>
            <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e74</con2:id>
            <con4:case>
              <con4:condition>
                <con2:xqueryText>fn:not(fn:contains($session, concat('&lt;userid>', $userId, '&lt;/userid>')))</con2:xqueryText>
              </con4:condition>
              <con4:actions>
                <con4:Error>
                  <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e73</con2:id>
                  <con4:errCode>400</con4:errCode>
                  <con4:message>Bad Request</con4:message>
                </con4:Error>
              </con4:actions>
            </con4:case>
          </con4:ifThenElse>
        </con:actions>
      </con:stage>
      <con:stage name="Get Profile">
        <con:context>
          <con1:userNsDecl namespace="http://com.finnair" prefix="com"/>
        </con:context>
        <con:actions>
          <con2:wsCallout>
            <con1:id>_ActionId-7415848483617704918-2167905b.14102d09993.-79b8</con1:id>
            <con2:service xsi:type="ref:ProxyRef" ref="CorporateUserProfile/proxies/GetCorporateUserProfileSalesforce" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con2:operation>GetCorporateUserProfile</con2:operation>
            <con2:request>
              <con2:body>$getProfileRQ</con2:body>
            </con2:request>
            <con2:response>
              <con2:body>getProfileRS</con2:body>
            </con2:response>
            <con2:requestTransform>
              <con2:assign varName="getProfileRQ">
                <con1:id>_ActionId-7415848483617704918-2167905b.14102d09993.-79b9</con1:id>
                <con2:expr>
                  <con1:xqueryText><![CDATA[<com:AMA_ProfileReadRQ Version="12.2">
         <com:UniqueID Type="21" ID="{$upUserId}" ID_Context="Username"/>
         <com:ReadRequests>
            <com:ProfileReadRequest ProfileType="1"/>
         </com:ReadRequests>
      </com:AMA_ProfileReadRQ>]]></con1:xqueryText>
                </con2:expr>
              </con2:assign>
            </con2:requestTransform>
            <con2:responseTransform/>
          </con2:wsCallout>
        </con:actions>
      </con:stage>
      <con:stage name="Check admin role">
        <con:context>
          <con1:userNsDecl namespace="http://com.finnair" prefix="com"/>
        </con:context>
        <con:actions>
          <con2:ifThenElse>
            <con1:id>_ActionId-7415848483617704918-2167905b.14102d09993.-7b16</con1:id>
            <con2:case>
              <con2:condition>
                <con1:xqueryText>$upUserId != $userId</con1:xqueryText>
              </con2:condition>
              <con2:actions>
                <con2:wsCallout>
                  <con1:id>_ActionId-7415848483617704918-2167905b.14102d09993.-7b12</con1:id>
                  <con2:service xsi:type="ref:ProxyRef" ref="CorporateUserProfile/proxies/GetCorporateUserProfileSalesforce" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                  <con2:operation>GetCorporateUserProfile</con2:operation>
                  <con2:request>
                    <con2:body>$getAdminUserProfileRQ</con2:body>
                  </con2:request>
                  <con2:response>
                    <con2:body>getAdminUserProfileRS</con2:body>
                  </con2:response>
                  <con2:requestTransform>
                    <con2:assign varName="getAdminUserProfileRQ">
                      <con1:id>_ActionId-7415848483617704918-2167905b.14102d09993.-7b13</con1:id>
                      <con2:expr>
                        <con1:xqueryText><![CDATA[<com:AMA_ProfileReadRQ Version="12.2">
         <com:UniqueID Type="21" ID="{$userId}" ID_Context="Username"/>
         <com:ReadRequests>
            <com:ProfileReadRequest ProfileType="1"/>
         </com:ReadRequests>
      </com:AMA_ProfileReadRQ>]]></con1:xqueryText>
                      </con2:expr>
                    </con2:assign>
                    <con2:ifThenElse>
                      <con1:id>_ActionId-7415848483617704918-2167905b.14102d09993.-7b0f</con1:id>
                      <con2:case>
                        <con2:condition>
                          <con1:xqueryConditionExpr>
                            <con1:boolExpr operator="or">
                              <con1:compExpr operator="!=">
                                <con1:leftPath>$getAdminUserProfileRS/com:ExternalID[@ID_Context='AY_Company_Key']/@ID</con1:leftPath>
                                <con1:rightPath>$getProfilesRS/com:ExternalID[@ID_Context='AY_Company_Key']/@ID</con1:rightPath>
                              </con1:compExpr>
                              <con1:compExpr operator="!=">
                                <con1:leftPath>$getAdminUserProfileRS/com:Profile/com:Agreements/com:OwnerRights/@RoleId</con1:leftPath>
                                <con1:rightPath>"A"</con1:rightPath>
                              </con1:compExpr>
                            </con1:boolExpr>
                          </con1:xqueryConditionExpr>
                        </con2:condition>
                        <con2:actions>
                          <con2:Error>
                            <con1:id>_ActionId-7415848483617704918-2167905b.14102d09993.-7b0e</con1:id>
                            <con2:errCode>400</con2:errCode>
                            <con2:message>Bad request</con2:message>
                          </con2:Error>
                        </con2:actions>
                      </con2:case>
                    </con2:ifThenElse>
                  </con2:requestTransform>
                  <con2:responseTransform/>
                </con2:wsCallout>
              </con2:actions>
            </con2:case>
          </con2:ifThenElse>
        </con:actions>
      </con:stage>
      <con:stage name="Update password to LDAP">
        <con:context>
          <con1:userNsDecl namespace="http://com.finnair/schemas/authenticationinfoprocessing" prefix="ns0"/>
          <con1:userNsDecl namespace="http://com.finnair/schemas/authenticationinfoprocessing" prefix="aut"/>
        </con:context>
        <con:actions>
          <con2:ifThenElse>
            <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-71e0</con1:id>
            <con2:case>
              <con2:condition>
                <con1:xqueryText>fn:string-length($password) > 0</con1:xqueryText>
              </con2:condition>
              <con2:actions>
                <con2:wsCallout>
                  <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7170</con1:id>
                  <con2:service xsi:type="ref:ProxyRef" ref="AuthenticationInfoProcessing/proxies/AuthenticationInfoProcessingV2.0" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                  <con2:operation>updateAuthenticationInfo</con2:operation>
                  <con2:request>
                    <con2:param>
                      <con2:name>UpdateAuthenticationInfoRequest</con2:name>
                      <con2:variable>$updateAuthenticationInfoRequest</con2:variable>
                    </con2:param>
                  </con2:request>
                  <con2:response>
                    <con2:param>
                      <con2:name>UpdateAuthenticationInfoResponse</con2:name>
                      <con2:variable>updateAuthenticationInfoResponse</con2:variable>
                    </con2:param>
                  </con2:response>
                  <con2:requestTransform>
                    <con2:assign varName="updateAuthenticationInfoRequest">
                      <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7138</con1:id>
                      <con2:expr>
                        <con1:xqueryText><![CDATA[<ns0:UpdateAuthenticationInfoRequest>
            <ns0:UserId>{ $upUserId }</ns0:UserId>
            <ns0:Password>{ $password }</ns0:Password>
            <ns0:Language></ns0:Language>
        </ns0:UpdateAuthenticationInfoRequest>]]></con1:xqueryText>
                      </con2:expr>
                    </con2:assign>
                  </con2:requestTransform>
                  <con2:responseTransform>
                    <con2:ifThenElse>
                      <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-700b</con1:id>
                      <con2:case>
                        <con2:condition>
                          <con1:xqueryText>$updateAuthenticationInfoResponse/aut:Error/aut:errorCode != 0</con1:xqueryText>
                        </con2:condition>
                        <con2:actions>
                          <con2:Error>
                            <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-6f9d</con1:id>
                            <con2:errCode>400</con2:errCode>
                            <con2:message>Unable to update password</con2:message>
                          </con2:Error>
                        </con2:actions>
                      </con2:case>
                    </con2:ifThenElse>
                  </con2:responseTransform>
                </con2:wsCallout>
              </con2:actions>
            </con2:case>
          </con2:ifThenElse>
        </con:actions>
      </con:stage>
      <con:stage name="Construct AMA_UpdateRQ">
        <con:context/>
        <con:actions>
          <con2:wsCallout>
            <con1:id>_ActionId-7415848483617704918-2167905b.14102d09993.-7911</con1:id>
            <con2:service xsi:type="ref:ProxyRef" ref="CorporateUserProfile/proxies/GetCorporateUserProfileSalesforce" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con2:operation>Update</con2:operation>
            <con2:request>
              <con2:body>$updateProfileRQ</con2:body>
            </con2:request>
            <con2:response>
              <con2:body>updateProfileRS</con2:body>
            </con2:response>
            <con2:requestTransform>
              <con2:assign varName="updateProfileRQ">
                <con1:id>_ActionId-7415848483617704918-2167905b.14102d09993.-790f</con1:id>
                <con2:expr>
                  <con1:xqueryTransform>
                    <con1:resource ref="CorporateUserProfile/transformations/Query2Update"/>
                    <con1:param name="params">
                      <con1:path>$params</con1:path>
                    </con1:param>
                  </con1:xqueryTransform>
                </con2:expr>
              </con2:assign>
            </con2:requestTransform>
            <con2:responseTransform/>
          </con2:wsCallout>
        </con:actions>
      </con:stage>
    </con:pipeline>
    <con:pipeline type="response" name="Update Corporate User_response">
      <con:stage name="ConvertToJSON">
        <con:context xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con1:varNsDecl namespace="http://com.finnair" prefix="com"/>
          <con5:variable name="createProfileRS" path="$createProfileRS" asChild="false" xmlns:con5="http://www.bea.com/wli/sb/typesystem/config">
            <con5:schema ref="PortalInterfaces/schema/AMA_ProfileCreateRS" element="AMA_ProfileCreateRS"/>
          </con5:variable>
        </con:context>
        <con:actions xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con5:ifThenElse xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-7415848483617704918-2167905b.14102d09993.-78d0</con1:id>
            <con5:case>
              <con5:condition>
                <con1:xqueryText>fn:exists($updateProfileRS/com:Success)</con1:xqueryText>
              </con5:condition>
              <con5:actions>
                <con5:replace varName="body" contents-only="true">
                  <con1:id>_ActionId-7415848483617704918-2167905b.14102d09993.-78cf</con1:id>
                  <con5:location>
                    <con1:xpathText>.</con1:xpathText>
                  </con5:location>
                  <con5:expr>
                    <con1:xqueryText>fn:concat(
$callback,
'({"statusCode":"OK"})'
)</con1:xqueryText>
                  </con5:expr>
                </con5:replace>
              </con5:actions>
            </con5:case>
            <con5:default>
              <con5:replace varName="body" contents-only="true">
                <con1:id>_ActionId-7415848483617704918-2167905b.14102d09993.-78ce</con1:id>
                <con5:location>
                  <con1:xpathText>.</con1:xpathText>
                </con5:location>
                <con5:expr>
                  <con1:xqueryText>fn:concat(
$callback,
"({",
"'error':'", $updateProfileRS/com:Errors/com:Error/@Code,"'",
"})"
)</con1:xqueryText>
                </con5:expr>
              </con5:replace>
            </con5:default>
          </con5:ifThenElse>
          <con5:transport-headers xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-7415848483617704918-2167905b.14102d09993.-78cd</con1:id>
            <con5:header-set>inbound-response</con5:header-set>
            <con5:header name="Content-Type" value="expression">
              <con1:xqueryText>'application/json'</con1:xqueryText>
            </con5:header>
          </con5:transport-headers>
        </con:actions>
      </con:stage>
      <con:stage name="Monitoring">
        <con:comment/>
        <con5:context xmlns:con="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/pipeline/config" xmlns:con5="http://www.bea.com/wli/sb/pipeline/config" xmlns:con4="http://www.bea.com/wli/sb/stages/alert/config" xmlns:aler="http://www.bea.com/wli/monitoring/alert" xmlns:con1="http://www.bea.com/wli/sb/typesystem/config">
          <con6:varNsDecl prefix="com" namespace="http://com.finnair" xmlns:con6="http://www.bea.com/wli/sb/stages/config"/>
          <con6:varNsDecl prefix="prof" namespace="http://com.finnair/profileProcessing/" xmlns:con6="http://www.bea.com/wli/sb/stages/config"/>
        </con5:context>
        <con5:actions xmlns:con="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/pipeline/config" xmlns:con5="http://www.bea.com/wli/sb/pipeline/config" xmlns:con4="http://www.bea.com/wli/sb/stages/alert/config" xmlns:aler="http://www.bea.com/wli/monitoring/alert" xmlns:con1="http://www.bea.com/wli/sb/typesystem/config">
          <con4:route xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config">
            <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e70</con6:id>
            <con4:service ref="GoogleAnalytics/businessservice/Monitoring" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con4:operation>monitor</con4:operation>
            <con4:outboundTransform>
              <con2:replace varName="body" contents-only="true">
                <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e6f</con6:id>
                <con2:location>
                  <con6:xpathText xmlns:con6="http://www.bea.com/wli/sb/stages/config">.</con6:xpathText>
                </con2:location>
                <con2:expr>
                  <con6:xqueryTransform xmlns:con6="http://www.bea.com/wli/sb/stages/config">
                    <con6:resource ref="GoogleAnalytics/transformations/XQ_Req_Monitoring"/>
                    <con6:param name="startTimestamp">
                      <con6:path>$startTimestamp</con6:path>
                    </con6:param>
                    <con6:param name="inbound">
                      <con6:path>$inbound</con6:path>
                    </con6:param>
                  </con6:xqueryTransform>
                </con2:expr>
              </con2:replace>
            </con4:outboundTransform>
          </con4:route>
          <con1:reply xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con="http://www.bea.com/wli/sb/pipeline/config" xmlns:con2="http://www.bea.com/wli/sb/typesystem/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config">
            <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e6e</con1:id>
          </con1:reply>
        </con5:actions>
      </con:stage>
    </con:pipeline>
    <con:pipeline type="request" name="Create Corporate User_request">
      <con:stage name="Setup">
        <con:context xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/typesystem/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con1:userNsDecl namespace="http://www.bea.com/wli/sb/services/security/config" prefix="con"/>
        </con:context>
        <con:actions xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/typesystem/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con5:assign varName="startTimestamp" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con4="http://www.bea.com/wli/sb/pipeline/config" xmlns:aler="http://www.bea.com/wli/monitoring/alert" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e26</con1:id>
            <con5:expr>
              <con:xqueryText xmlns:con="http://www.bea.com/wli/sb/stages/config">current-dateTime()</con:xqueryText>
            </con5:expr>
          </con5:assign>
          <con1:ifThenElse xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e25</con5:id>
            <con1:case>
              <con1:condition>
                <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">fn:not(fn:exists($inbound/ctx:transport/ctx:request/http:query-string))</con5:xqueryText>
              </con1:condition>
              <con1:actions>
                <con1:Error>
                  <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e24</con5:id>
                  <con1:errCode>400</con1:errCode>
                  <con1:message>Bad Request</con1:message>
                </con1:Error>
              </con1:actions>
            </con1:case>
          </con1:ifThenElse>
          <con1:assign varName="params" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e23</con5:id>
            <con1:expr>
              <con5:xqueryTransform xmlns:con5="http://www.bea.com/wli/sb/stages/config">
                <con5:resource ref="Common/transformations/XQ_Parse_QueryString"/>
                <con5:param name="qs">
                  <con5:path>data($inbound/ctx:transport/ctx:request/http:query-string)</con5:path>
                </con5:param>
              </con5:xqueryTransform>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="callback" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e22</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="callback"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="token" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e21</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="token"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="clientId" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e20</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="upClientId"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="userId" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e1f</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="userId"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="method" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e1e</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="method"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
        </con:actions>
      </con:stage>
      <con:stage name="Validate token">
        <con:context xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config"/>
        <con:actions xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config">
          <con4:javaCallout varName="session" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
            <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e1d</con2:id>
            <con4:archive ref="partnerServices/PartnerMWSupport"/>
            <con4:className>fi.finnair.session.SessionRegistry</con4:className>
            <con4:method>public static java.lang.String getSession(java.lang.String)</con4:method>
            <con4:expr>
              <con2:xqueryText>$token</con2:xqueryText>
            </con4:expr>
          </con4:javaCallout>
          <con4:ifThenElse xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
            <con2:comment>Check for dummy token</con2:comment>
            <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e1c</con2:id>
            <con4:case>
              <con4:condition>
                <con2:xqueryText>fn:not(fn:contains($session, concat('&lt;userid>', $userId, '&lt;/userid>')))</con2:xqueryText>
              </con4:condition>
              <con4:actions>
                <con4:Error>
                  <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e1b</con2:id>
                  <con4:errCode>400</con4:errCode>
                  <con4:message>Bad Request</con4:message>
                </con4:Error>
              </con4:actions>
            </con4:case>
          </con4:ifThenElse>
        </con:actions>
      </con:stage>
      <con:stage name="Check admin role">
        <con:context>
          <con1:userNsDecl namespace="http://com.finnair" prefix="com"/>
        </con:context>
        <con:actions>
          <con2:wsCallout>
            <con1:id>_ActionId-515672032373458334--7af4d0c7.140f20fe443.-7eee</con1:id>
            <con2:service xsi:type="ref:ProxyRef" ref="CorporateUserProfile/proxies/GetCorporateUserProfileSalesforce" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con2:operation>GetCorporateUserProfile</con2:operation>
            <con2:request>
              <con2:body>$getAdminUserProfileRQ</con2:body>
            </con2:request>
            <con2:response>
              <con2:body>getAdminUserProfileRS</con2:body>
            </con2:response>
            <con2:requestTransform>
              <con2:assign varName="getAdminUserProfileRQ">
                <con1:id>_ActionId-515672032373458334--7af4d0c7.140f20fe443.-7eef</con1:id>
                <con2:expr>
                  <con1:xqueryText><![CDATA[<com:AMA_ProfileReadRQ Version="12.2">
         <com:UniqueID Type="21" ID="{$userId}" ID_Context="Username"/>
         <com:ReadRequests>
            <com:ProfileReadRequest ProfileType="1"/>
         </com:ReadRequests>
      </com:AMA_ProfileReadRQ>]]></con1:xqueryText>
                </con2:expr>
              </con2:assign>
            </con2:requestTransform>
            <con2:responseTransform/>
          </con2:wsCallout>
          <con2:ifThenElse>
            <con1:id>_ActionId-515672032373458334--7af4d0c7.140f20fe443.-7e3d</con1:id>
            <con2:case>
              <con2:condition>
                <con1:xqueryConditionExpr>
                  <con1:boolExpr operator="or">
                    <con1:compExpr operator="!=">
                      <con1:leftPath>$getAdminUserProfileRS/com:ExternalID[@ID_Context='AY_Company_Key']/@ID</con1:leftPath>
                      <con1:rightPath>$clientId</con1:rightPath>
                    </con1:compExpr>
                    <con1:compExpr operator="!=">
                      <con1:leftPath>$getAdminUserProfileRS/com:Profile/com:Agreements/com:OwnerRights/@RoleId</con1:leftPath>
                      <con1:rightPath>"A"</con1:rightPath>
                    </con1:compExpr>
                  </con1:boolExpr>
                </con1:xqueryConditionExpr>
              </con2:condition>
              <con2:actions>
                <con2:Error>
                  <con1:id>_ActionId-1990068611190553592--2955b51f.141022c0882.-7f92</con1:id>
                  <con2:errCode>400</con2:errCode>
                  <con2:message>Bad request</con2:message>
                </con2:Error>
              </con2:actions>
            </con2:case>
          </con2:ifThenElse>
        </con:actions>
      </con:stage>
      <con:stage name="Create profile">
        <con:context/>
        <con:actions>
          <con2:wsCallout>
            <con1:id>_ActionId-1990068611190553592--2955b51f.141022c0882.-7f47</con1:id>
            <con2:service xsi:type="ref:ProxyRef" ref="CorporateUserProfile/proxies/GetCorporateUserProfileSalesforce" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con2:operation>Insert</con2:operation>
            <con2:request>
              <con2:body>$createProfileRQ</con2:body>
            </con2:request>
            <con2:response>
              <con2:body>createProfileRS</con2:body>
            </con2:response>
            <con2:requestTransform>
              <con2:assign varName="createProfileRQ">
                <con1:id>_ActionId-1990068611190553592--2955b51f.141022c0882.-7f12</con1:id>
                <con2:expr>
                  <con1:xqueryTransform>
                    <con1:resource ref="CorporateUserProfile/transformations/Query2Insert"/>
                    <con1:param name="params">
                      <con1:path>$params</con1:path>
                    </con1:param>
                  </con1:xqueryTransform>
                </con2:expr>
              </con2:assign>
            </con2:requestTransform>
            <con2:responseTransform/>
          </con2:wsCallout>
        </con:actions>
      </con:stage>
    </con:pipeline>
    <con:pipeline type="response" name="Create Corporate User_response">
      <con:stage name="ConvertToJSON">
        <con:context xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con1:varNsDecl namespace="http://com.finnair" prefix="com"/>
          <con5:variable name="createProfileRS" path="$createProfileRS" asChild="false" xmlns:con5="http://www.bea.com/wli/sb/typesystem/config">
            <con5:schema ref="PortalInterfaces/schema/AMA_ProfileCreateRS" element="AMA_ProfileCreateRS"/>
          </con5:variable>
        </con:context>
        <con:actions xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con5:ifThenElse xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-1990068611190553592--2955b51f.141022c0882.-7ee3</con1:id>
            <con5:case>
              <con5:condition>
                <con1:xqueryText>fn:exists($createProfileRS/com:Success)</con1:xqueryText>
              </con5:condition>
              <con5:actions>
                <con5:replace varName="body" contents-only="true">
                  <con1:id>_ActionId-1990068611190553592--2955b51f.141022c0882.-7ee1</con1:id>
                  <con5:location>
                    <con1:xpathText>.</con1:xpathText>
                  </con5:location>
                  <con5:expr>
                    <con1:xqueryText>fn:concat(
$callback,
'({"statusCode":"OK",
   "siebelId" : "', $createProfileRS/com:UniqueID[@ID_Context="CRM"]/@ID, 
   '",
   "username" : "', $createProfileRS/com:UniqueID[@ID_Context="Portal"]/@ID, '"})'
)</con1:xqueryText>
                  </con5:expr>
                </con5:replace>
              </con5:actions>
            </con5:case>
            <con5:default>
              <con5:replace varName="body" contents-only="true">
                <con1:id>_ActionId-1990068611190553592--2955b51f.141022c0882.-7eba</con1:id>
                <con5:location>
                  <con1:xpathText>.</con1:xpathText>
                </con5:location>
                <con5:expr>
                  <con1:xqueryText>fn:concat(
$callback,
"({",
"'error':'", $createProfileRS/com:Errors/com:Error/@Code,"'",
"})"
)</con1:xqueryText>
                </con5:expr>
              </con5:replace>
            </con5:default>
          </con5:ifThenElse>
          <con5:transport-headers xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e19</con1:id>
            <con5:header-set>inbound-response</con5:header-set>
            <con5:header name="Content-Type" value="expression">
              <con1:xqueryText>'application/json'</con1:xqueryText>
            </con5:header>
          </con5:transport-headers>
        </con:actions>
      </con:stage>
      <con:stage name="Monitoring">
        <con:comment/>
        <con5:context xmlns:con="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/pipeline/config" xmlns:con5="http://www.bea.com/wli/sb/pipeline/config" xmlns:con4="http://www.bea.com/wli/sb/stages/alert/config" xmlns:aler="http://www.bea.com/wli/monitoring/alert" xmlns:con1="http://www.bea.com/wli/sb/typesystem/config">
          <con6:varNsDecl prefix="com" namespace="http://com.finnair" xmlns:con6="http://www.bea.com/wli/sb/stages/config"/>
          <con6:varNsDecl prefix="prof" namespace="http://com.finnair/profileProcessing/" xmlns:con6="http://www.bea.com/wli/sb/stages/config"/>
        </con5:context>
        <con5:actions xmlns:con="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/pipeline/config" xmlns:con5="http://www.bea.com/wli/sb/pipeline/config" xmlns:con4="http://www.bea.com/wli/sb/stages/alert/config" xmlns:aler="http://www.bea.com/wli/monitoring/alert" xmlns:con1="http://www.bea.com/wli/sb/typesystem/config">
          <con4:route xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config">
            <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e18</con6:id>
            <con4:service ref="GoogleAnalytics/businessservice/Monitoring" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con4:operation>monitor</con4:operation>
            <con4:outboundTransform>
              <con2:replace varName="body" contents-only="true">
                <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e17</con6:id>
                <con2:location>
                  <con6:xpathText xmlns:con6="http://www.bea.com/wli/sb/stages/config">.</con6:xpathText>
                </con2:location>
                <con2:expr>
                  <con6:xqueryTransform xmlns:con6="http://www.bea.com/wli/sb/stages/config">
                    <con6:resource ref="GoogleAnalytics/transformations/XQ_Req_Monitoring"/>
                    <con6:param name="startTimestamp">
                      <con6:path>$startTimestamp</con6:path>
                    </con6:param>
                    <con6:param name="inbound">
                      <con6:path>$inbound</con6:path>
                    </con6:param>
                  </con6:xqueryTransform>
                </con2:expr>
              </con2:replace>
            </con4:outboundTransform>
          </con4:route>
          <con1:reply xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con="http://www.bea.com/wli/sb/pipeline/config" xmlns:con2="http://www.bea.com/wli/sb/typesystem/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config">
            <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7e16</con1:id>
          </con1:reply>
        </con5:actions>
      </con:stage>
    </con:pipeline>
    <con:pipeline type="request" name="Delete corporate User_request">
      <con:stage name="Setup">
        <con:context xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/typesystem/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con1:userNsDecl namespace="http://www.bea.com/wli/sb/services/security/config" prefix="con"/>
        </con:context>
        <con:actions xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/typesystem/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con5:assign varName="startTimestamp" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con4="http://www.bea.com/wli/sb/pipeline/config" xmlns:aler="http://www.bea.com/wli/monitoring/alert" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7dce</con1:id>
            <con5:expr>
              <con:xqueryText xmlns:con="http://www.bea.com/wli/sb/stages/config">current-dateTime()</con:xqueryText>
            </con5:expr>
          </con5:assign>
          <con1:ifThenElse xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7dcd</con5:id>
            <con1:case>
              <con1:condition>
                <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">fn:not(fn:exists($inbound/ctx:transport/ctx:request/http:query-string))</con5:xqueryText>
              </con1:condition>
              <con1:actions>
                <con1:Error>
                  <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7dcc</con5:id>
                  <con1:errCode>400</con1:errCode>
                  <con1:message>Bad Request</con1:message>
                </con1:Error>
              </con1:actions>
            </con1:case>
          </con1:ifThenElse>
          <con1:assign varName="params" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7dcb</con5:id>
            <con1:expr>
              <con5:xqueryTransform xmlns:con5="http://www.bea.com/wli/sb/stages/config">
                <con5:resource ref="Common/transformations/XQ_Parse_QueryString"/>
                <con5:param name="qs">
                  <con5:path>data($inbound/ctx:transport/ctx:request/http:query-string)</con5:path>
                </con5:param>
              </con5:xqueryTransform>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="callback" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7dca</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="callback"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="token" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7dc9</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="token"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="userId" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7dc7</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$params/param[@name="userId"]/@value</con5:xqueryText>
            </con1:expr>
          </con1:assign>
          <con5:assign varName="delUserId" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7d0a</con1:id>
            <con5:expr>
              <con1:xqueryText>$params/param[@name="delUserId"]/@value</con1:xqueryText>
            </con5:expr>
          </con5:assign>
        </con:actions>
      </con:stage>
      <con:stage name="Validate token">
        <con:context xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config"/>
        <con:actions xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config">
          <con4:javaCallout varName="session" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
            <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7dc5</con2:id>
            <con4:archive ref="partnerServices/PartnerMWSupport"/>
            <con4:className>fi.finnair.session.SessionRegistry</con4:className>
            <con4:method>public static java.lang.String getSession(java.lang.String)</con4:method>
            <con4:expr>
              <con2:xqueryText>$token</con2:xqueryText>
            </con4:expr>
          </con4:javaCallout>
          <con4:ifThenElse xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
            <con2:comment>Check for dummy token</con2:comment>
            <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7dc4</con2:id>
            <con4:case>
              <con4:condition>
                <con2:xqueryText>fn:not(fn:contains($session, concat('&lt;userid>', $userId, '&lt;/userid>')))</con2:xqueryText>
              </con4:condition>
              <con4:actions>
                <con4:Error>
                  <con2:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7dc3</con2:id>
                  <con4:errCode>400</con4:errCode>
                  <con4:message>Bad Request</con4:message>
                </con4:Error>
              </con4:actions>
            </con4:case>
          </con4:ifThenElse>
        </con:actions>
      </con:stage>
      <con:stage name="Get Profile">
        <con:context>
          <con1:userNsDecl namespace="http://com.finnair" prefix="com"/>
        </con:context>
        <con:actions>
          <con2:wsCallout>
            <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7b29</con1:id>
            <con2:service xsi:type="ref:ProxyRef" ref="CorporateUserProfile/proxies/GetCorporateUserProfileSalesforce" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con2:operation>GetCorporateUserProfile</con2:operation>
            <con2:request>
              <con2:body>$getProfileRQ</con2:body>
            </con2:request>
            <con2:response>
              <con2:body>getProfileRS</con2:body>
            </con2:response>
            <con2:requestTransform>
              <con2:assign varName="getProfileRQ">
                <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7b2a</con1:id>
                <con2:expr>
                  <con1:xqueryText><![CDATA[<com:AMA_ProfileReadRQ Version="12.2">
         <com:UniqueID Type="22" ID="{$delUserId}" ID_Context="Username"/>
         <com:ReadRequests>
            <com:ProfileReadRequest ProfileType="1"/>
         </com:ReadRequests>
      </com:AMA_ProfileReadRQ>]]></con1:xqueryText>
                </con2:expr>
              </con2:assign>
            </con2:requestTransform>
            <con2:responseTransform/>
          </con2:wsCallout>
        </con:actions>
      </con:stage>
      <con:stage name="Get Admin Profile">
        <con:context>
          <con1:userNsDecl namespace="http://com.finnair" prefix="com"/>
        </con:context>
        <con:actions>
          <con2:wsCallout>
            <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7abb</con1:id>
            <con2:service xsi:type="ref:ProxyRef" ref="CorporateUserProfile/proxies/GetCorporateUserProfileSalesforce" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con2:operation>GetCorporateUserProfile</con2:operation>
            <con2:request>
              <con2:body>$getAdminProfileRQ</con2:body>
            </con2:request>
            <con2:response>
              <con2:body>getAdminProfileRS</con2:body>
            </con2:response>
            <con2:requestTransform>
              <con2:assign varName="getAdminProfileRQ">
                <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7ab8</con1:id>
                <con2:expr>
                  <con1:xqueryText><![CDATA[<com:AMA_ProfileReadRQ Version="12.2">
         <com:UniqueID Type="21" ID="{$userId}" ID_Context="Username"/>
         <com:ReadRequests>
            <com:ProfileReadRequest ProfileType="1"/>
         </com:ReadRequests>
      </com:AMA_ProfileReadRQ>]]></con1:xqueryText>
                </con2:expr>
              </con2:assign>
            </con2:requestTransform>
            <con2:responseTransform/>
          </con2:wsCallout>
        </con:actions>
      </con:stage>
      <con:stage name="Check admin rights">
        <con:context>
          <con1:userNsDecl namespace="http://com.finnair" prefix="com"/>
        </con:context>
        <con:actions>
          <con2:ifThenElse>
            <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7a4a</con1:id>
            <con2:case>
              <con2:condition>
                <con1:xqueryText>($getAdminProfileRS//com:ExternalID[@ID_Context='AY_Company_Key']/@ID != $getProfileRS//com:ExternalID[@ID_Context='AY_Company_Key']/@ID) or $getAdminProfileRS//com:OwnerRights/@RoleId != "A"</con1:xqueryText>
              </con2:condition>
              <con2:actions>
                <con2:Error>
                  <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7969</con1:id>
                  <con2:errCode>400</con2:errCode>
                  <con2:message>Bad request</con2:message>
                </con2:Error>
              </con2:actions>
            </con2:case>
          </con2:ifThenElse>
        </con:actions>
      </con:stage>
      <con:stage name="Create DeleteRQ">
        <con:context>
          <con1:userNsDecl namespace="http://www.example.org/GetCorporateUserProfile" prefix="get"/>
          <con1:userNsDecl namespace="http://com.finnair" prefix="com"/>
        </con:context>
        <con:actions>
          <con2:wsCallout>
            <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7c15</con1:id>
            <con2:service xsi:type="ref:ProxyRef" ref="CorporateUserProfile/proxies/GetCorporateUserProfileSalesforce" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con2:operation>Delete</con2:operation>
            <con2:request>
              <con2:body>$deleteProfileRQ</con2:body>
            </con2:request>
            <con2:response>
              <con2:body>deleteProfileRS</con2:body>
            </con2:response>
            <con2:requestTransform>
              <con2:assign varName="siebelId">
                <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-75b0</con1:id>
                <con2:expr>
                  <con1:xqueryText>data($getProfileRS/com:Profiles/com:ProfileInfo/com:Profile/com:UserID[@Type='18']/@ID)</con1:xqueryText>
                </con2:expr>
              </con2:assign>
              <con2:assign varName="deleteProfileRQ">
                <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7bdd</con1:id>
                <con2:expr>
                  <con1:xqueryText>&lt;get:DeleteRQ xmlns:get="http://www.example.org/GetCorporateUserProfile/">
&lt;get:contactId>
{$siebelId}
&lt;/get:contactId>
&lt;/get:DeleteRQ></con1:xqueryText>
                </con2:expr>
              </con2:assign>
            </con2:requestTransform>
            <con2:responseTransform/>
          </con2:wsCallout>
        </con:actions>
      </con:stage>
    </con:pipeline>
    <con:pipeline type="response" name="Delete corporate User_response">
      <con:stage name="ConvertToJSON">
        <con:context xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con1:userNsDecl namespace="http://com.finnair" prefix="com"/>
        </con:context>
        <con:actions xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
          <con5:ifThenElse xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7ba5</con1:id>
            <con5:case>
              <con5:condition>
                <con1:xqueryText>$deleteProfileRS/StatusCode = "OK"</con1:xqueryText>
              </con5:condition>
              <con5:actions>
                <con5:replace contents-only="true" varName="body">
                  <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7b65</con1:id>
                  <con5:location>
                    <con1:xpathText>.</con1:xpathText>
                  </con5:location>
                  <con5:expr>
                    <con1:xqueryText>fn:concat(
$callback,
'({"statusCode":"OK"})'
)</con1:xqueryText>
                  </con5:expr>
                </con5:replace>
              </con5:actions>
            </con5:case>
            <con5:default>
              <con5:ifThenElse>
                <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-774b</con1:id>
                <con5:case>
                  <con5:condition>
                    <con1:xqueryText>fn:empty($deleteProfileRS/StatusCode)</con1:xqueryText>
                  </con5:condition>
                  <con5:actions>
                    <con5:assign varName="errorCode">
                      <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7713</con1:id>
                      <con5:expr>
                        <con1:xqueryText>400</con1:xqueryText>
                      </con5:expr>
                    </con5:assign>
                  </con5:actions>
                </con5:case>
                <con5:default>
                  <con5:assign varName="errorCode">
                    <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-76db</con1:id>
                    <con5:expr>
                      <con1:xqueryText>$deleteProfileRS/StatusCode</con1:xqueryText>
                    </con5:expr>
                  </con5:assign>
                </con5:default>
              </con5:ifThenElse>
              <con5:replace varName="body" contents-only="true">
                <con1:id>_ActionId-4257892934516579246--7e4eef3c.1410bffa6b6.-7ba1</con1:id>
                <con5:location>
                  <con1:xpathText>.</con1:xpathText>
                </con5:location>
                <con5:expr>
                  <con1:xqueryText>fn:concat(
$callback,
"({",
"'error':'", $errorCode,"'",
"})"
)</con1:xqueryText>
                </con5:expr>
              </con5:replace>
            </con5:default>
          </con5:ifThenElse>
          <con5:transport-headers xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7dc1</con1:id>
            <con5:header-set>inbound-response</con5:header-set>
            <con5:header name="Content-Type" value="expression">
              <con1:xqueryText>'application/json'</con1:xqueryText>
            </con5:header>
          </con5:transport-headers>
        </con:actions>
      </con:stage>
      <con:stage name="Monitoring">
        <con:comment/>
        <con5:context xmlns:con="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/pipeline/config" xmlns:con5="http://www.bea.com/wli/sb/pipeline/config" xmlns:con4="http://www.bea.com/wli/sb/stages/alert/config" xmlns:aler="http://www.bea.com/wli/monitoring/alert" xmlns:con1="http://www.bea.com/wli/sb/typesystem/config">
          <con6:varNsDecl prefix="com" namespace="http://com.finnair" xmlns:con6="http://www.bea.com/wli/sb/stages/config"/>
          <con6:varNsDecl prefix="prof" namespace="http://com.finnair/profileProcessing/" xmlns:con6="http://www.bea.com/wli/sb/stages/config"/>
        </con5:context>
        <con5:actions xmlns:con="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/pipeline/config" xmlns:con5="http://www.bea.com/wli/sb/pipeline/config" xmlns:con4="http://www.bea.com/wli/sb/stages/alert/config" xmlns:aler="http://www.bea.com/wli/monitoring/alert" xmlns:con1="http://www.bea.com/wli/sb/typesystem/config">
          <con4:route xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config">
            <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7dc0</con6:id>
            <con4:service ref="GoogleAnalytics/businessservice/Monitoring" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con4:operation>monitor</con4:operation>
            <con4:outboundTransform>
              <con2:replace varName="body" contents-only="true">
                <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7dbf</con6:id>
                <con2:location>
                  <con6:xpathText xmlns:con6="http://www.bea.com/wli/sb/stages/config">.</con6:xpathText>
                </con2:location>
                <con2:expr>
                  <con6:xqueryTransform xmlns:con6="http://www.bea.com/wli/sb/stages/config">
                    <con6:resource ref="GoogleAnalytics/transformations/XQ_Req_Monitoring"/>
                    <con6:param name="startTimestamp">
                      <con6:path>$startTimestamp</con6:path>
                    </con6:param>
                    <con6:param name="inbound">
                      <con6:path>$inbound</con6:path>
                    </con6:param>
                  </con6:xqueryTransform>
                </con2:expr>
              </con2:replace>
            </con4:outboundTransform>
          </con4:route>
          <con1:reply xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con="http://www.bea.com/wli/sb/pipeline/config" xmlns:con2="http://www.bea.com/wli/sb/typesystem/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config">
            <con1:id>_ActionId-5103501488779744090--16f5ae4c.140538b7dc4.-7dbe</con1:id>
          </con1:reply>
        </con5:actions>
      </con:stage>
    </con:pipeline>
    <con:pipeline type="error" name="_onErrorHandler-5103501488779744090--16f5ae4c.140538b7dc4.-7d27">
      <con:stage name="Get Profile call error handler">
        <con:context>
          <con1:userNsDecl namespace="http://com.finnair" prefix="com"/>
        </con:context>
        <con:actions>
          <con3:log xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config">
            <con2:id>_ActionId-3587372809334780688--2e9df170.1405cdffe1a.-7ffe</con2:id>
            <con3:logLevel>error</con3:logLevel>
            <con3:expr>
              <con2:xqueryText>$fault</con2:xqueryText>
            </con3:expr>
          </con3:log>
          <con2:ifThenElse>
            <con1:id>_ActionId-3587372809334780688--2e9df170.1405cdffe1a.-7fb2</con1:id>
            <con2:case>
              <con2:condition>
                <con1:xqueryText>$getProfileRS/com:Error/@Code = "11"</con1:xqueryText>
              </con2:condition>
              <con2:actions>
                <con2:Error>
                  <con1:id>_ActionId-3587372809334780688--2e9df170.1405cdffe1a.-7f9c</con1:id>
                  <con2:errCode>500</con2:errCode>
                  <con2:message>Unable to Process</con2:message>
                </con2:Error>
              </con2:actions>
            </con2:case>
            <con2:default>
              <con2:Error>
                <con1:id>_ActionId-3587372809334780688--2e9df170.1405cdffe1a.-7f85</con1:id>
                <con2:errCode>404</con2:errCode>
                <con2:message>No Profiles found</con2:message>
              </con2:Error>
            </con2:default>
          </con2:ifThenElse>
        </con:actions>
      </con:stage>
    </con:pipeline>
    <con:pipeline type="request" name="Generic initialization_request">
      <con:stage name="URIParsing" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con4="http://www.bea.com/wli/sb/typesystem/config">
        <con:context/>
        <con:actions>
          <con1:assign varName="noSlashRelativeURI" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7358165213384394185--72eb296b.14743ec71b3.-7d23</con5:id>
            <con1:expr>
              <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">fn:replace($inbound/ctx:transport/ctx:request/http:relative-URI/text(), "/", "")</con5:xqueryText>
            </con1:expr>
          </con1:assign>
        </con:actions>
      </con:stage>
    </con:pipeline>
    <con:pipeline type="response" name="Generic initialization_response"/>
    <con:flow>
      <con:pipeline-node name="Generic initialization">
        <con:request>Generic initialization_request</con:request>
        <con:response>Generic initialization_response</con:response>
      </con:pipeline-node>
      <con:branch-node type="condition" name="Method selection">
        <con:context/>
        <con:branch-table variable="noSlashRelativeURI">
          <con:branch name="DELETE">
            <con:operator>equals</con:operator>
            <con:value>'delete'</con:value>
            <con:flow>
              <con:pipeline-node name="Delete corporate User">
                <con:request>Delete corporate User_request</con:request>
                <con:response>Delete corporate User_response</con:response>
              </con:pipeline-node>
            </con:flow>
          </con:branch>
          <con:branch name="CREATE">
            <con:operator>equals</con:operator>
            <con:value>'create'</con:value>
            <con:flow>
              <con:pipeline-node name="Create Corporate User">
                <con:request>Create Corporate User_request</con:request>
                <con:response>Create Corporate User_response</con:response>
              </con:pipeline-node>
            </con:flow>
          </con:branch>
          <con:branch name="UPDATE">
            <con:operator>equals</con:operator>
            <con:value>'update'</con:value>
            <con:flow>
              <con:pipeline-node name="Update Corporate User">
                <con:request>Update Corporate User_request</con:request>
                <con:response>Update Corporate User_response</con:response>
              </con:pipeline-node>
            </con:flow>
          </con:branch>
          <con:default-branch>
            <con:flow>
              <con:pipeline-node name="Get Corporate User">
                <con:request>Get Corporate User_request</con:request>
                <con:response>Get Corporate User_response</con:response>
              </con:pipeline-node>
            </con:flow>
          </con:default-branch>
        </con:branch-table>
      </con:branch-node>
    </con:flow>
  </ser:router>
</xml-fragment>